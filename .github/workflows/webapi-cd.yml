name: WebAPI CD Pipeline

on:
  # Release-based deployment only
  push:
    tags:
      - 'webapi-v*'           # webapi-v1.0.0, webapi-v1.1.0-dev
  
  # Manual emergency deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'dev'
        type: choice
        options:
          - 'dev'
          - 'prod'
      release_tag:
        description: 'Release tag to deploy (e.g., webapi-v1.0.0)'
        required: true
        type: string
      skip_tests:
        description: 'Skip CI validation (emergency only)'
        required: false
        default: false
        type: boolean
      seed_database:
        description: 'Seed database with sample data'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '22'

permissions:
  actions: read
  contents: read
  security-events: write
  id-token: write

jobs:
  # ============================================================================
  # RELEASE VALIDATION & ENVIRONMENT DETERMINATION
  # ============================================================================

  validate-release:
    name: ğŸ·ï¸ Validate Release Tag
    runs-on: ubuntu-latest
    outputs:
      release-tag: ${{ steps.release.outputs.tag }}
      target-env: ${{ steps.release.outputs.environment }}
      is-dev-release: ${{ steps.release.outputs.is-dev }}
      is-prod-release: ${{ steps.release.outputs.is-prod }}
    
    steps:
      - name: Extract Release Information
        id: release
        run: |
          echo "ğŸ·ï¸ Analyzing release information..."
          
          if [ "${{ github.event_name }}" = "push" ]; then
            # Tag-based deployment
            TAG="${{ github.ref_name }}"
            echo "ğŸ“Œ Tag-triggered deployment: $TAG"
          else
            # Manual deployment
            TAG="${{ github.event.inputs.release_tag }}"
            echo "ğŸ›ï¸ Manual deployment: $TAG"
          fi
          
          # Determine target environment
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET_ENV="${{ github.event.inputs.environment }}"
            echo "ğŸ¯ Manual target: $TARGET_ENV"
          elif [[ "$TAG" =~ -dev$|-beta$|-alpha$|-rc ]]; then
            TARGET_ENV="dev"
            echo "ğŸ”¨ Development release detected"
          else
            TARGET_ENV="prod" 
            echo "ğŸ­ Production release detected"
          fi
          
          # Validate tag format
          if [[ ! "$TAG" =~ ^webapi-v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
            echo "âŒ Invalid tag format: $TAG"
            echo "Expected format: webapi-v1.0.0 or webapi-v1.0.0-dev"
            exit 1
          fi
          
          # Set outputs
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "environment=$TARGET_ENV" >> $GITHUB_OUTPUT
          echo "is-dev=$( [[ $TARGET_ENV == 'dev' ]] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          echo "is-prod=$( [[ $TARGET_ENV == 'prod' ]] && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
          
          echo "âœ… Release validation completed"
          echo "ğŸ·ï¸ Tag: $TAG"
          echo "ğŸ¯ Environment: $TARGET_ENV"

  # ============================================================================
  # CI VALIDATION (for release artifacts)
  # ============================================================================

  ci:
    name: ğŸ”„ CI Validation
    needs: validate-release
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    outputs:
      artifact-name: ${{ steps.ci.outputs.artifact-name }}
      quality-passed: ${{ steps.ci.outputs.quality-passed }}
      test-results: ${{ steps.ci.outputs.test-results }}
      coverage-percentage: ${{ steps.ci.outputs.coverage-percentage }}

    steps:
      - name: Checkout Release Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.release-tag }}

      - name: Run CI Pipeline
        id: ci
        uses: ./.github/actions/node-ci
        with:
          node-version: '22'
          working-directory: 'src/webapi'
          skip-tests: false
          package-manager: 'npm'
          ignore-audit-errors: true
          audit-level: 'moderate'

  security-scan:
    name: ğŸ›¡ï¸ Security Validation
    needs: [validate-release, ci]
    if: github.event.inputs.skip_tests != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Release Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.release-tag }}

      - name: Run Security Scan
        uses: ./.github/actions/security-scan
        with:
          working-directory: 'src/webapi'
          language: 'javascript'
          audit-level: 'moderate'
          fail-on-error: false

  # ============================================================================
  # DEVELOPMENT DEPLOYMENT
  # ============================================================================

  deploy-dev:
    name: ğŸš€ Deploy to Development
    needs: [validate-release, ci, security-scan]
    if: always() && needs.validate-release.outputs.is-dev-release == 'true' && (needs.ci.outputs.quality-passed == 'true' || github.event.inputs.skip_tests == 'true')
    runs-on: ubuntu-latest
    environment: 
      name: development
      url: ${{ steps.deploy.outputs.webapp-url }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: Checkout Release Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.release-tag }}

      - name: Download Build Artifact
        if: needs.ci.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.ci.outputs.artifact-name }}
          path: ./build

      - name: Deploy to Azure App Service
        id: deploy
        run: |
          echo "ğŸš€ Deploying WebAPI to Development Environment"
          echo "ğŸ·ï¸ Release: ${{ needs.validate-release.outputs.release-tag }}"
          echo "ğŸŒ± Seed Database: ${{ github.event.inputs.seed_database == 'true' }}"
          
          # TODO: Add actual Azure deployment steps here
          # az webapp deployment source config-zip ...
          
          echo "webapp-url=https://sportiverse-webapi-dev.azurewebsites.net" >> $GITHUB_OUTPUT
          echo "âœ… Development deployment completed"

  # ============================================================================
  # PRODUCTION DEPLOYMENT (with approval)
  # ============================================================================

  deploy-prod:
    name: ğŸ­ Deploy to Production
    needs: [validate-release, ci, security-scan]
    if: always() && needs.validate-release.outputs.is-prod-release == 'true' && (needs.ci.outputs.quality-passed == 'true' || github.event.inputs.skip_tests == 'true')
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: ${{ steps.deploy.outputs.webapp-url }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.webapp-url }}

    steps:
      - name: Checkout Release Tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate-release.outputs.release-tag }}

      - name: Download Build Artifact
        if: needs.ci.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.ci.outputs.artifact-name }}
          path: ./build

      - name: Deploy to Azure App Service
        id: deploy
        run: |
          echo "ğŸ­ Deploying WebAPI to Production Environment"
          echo "ğŸ·ï¸ Release: ${{ needs.validate-release.outputs.release-tag }}"
          echo "ğŸ”’ Production deployment - no database seeding"
          
          # TODO: Add actual Azure deployment steps here
          # az webapp deployment source config-zip ...
          
          echo "webapp-url=https://sportiverse-webapi.azurewebsites.net" >> $GITHUB_OUTPUT
          echo "âœ… Production deployment completed"

  # ============================================================================
  # POST-DEPLOYMENT VERIFICATION
  # ============================================================================

  health-check:
    name: ğŸ¥ Health Check
    needs: [validate-release, deploy-dev, deploy-prod]
    if: always() && (needs.deploy-dev.result == 'success' || needs.deploy-prod.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: API Health Check
        run: |
          echo "ğŸ¥ Performing post-deployment health check..."
          
          API_URL="${{ needs.deploy-dev.outputs.deployment-url || needs.deploy-prod.outputs.deployment-url }}"
          echo "ğŸŒ API URL: $API_URL"
          
          # Wait for deployment to stabilize
          echo "â³ Waiting 30 seconds for deployment to stabilize..."
          sleep 30
          
          # Test health endpoint
          echo "ğŸ” Testing /status endpoint..."
          if curl -f "$API_URL/status" --max-time 30; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
          
          # Test API endpoints
          echo "ğŸ” Testing /api/products endpoint..."
          if curl -f "$API_URL/api/products" --max-time 30; then
            echo "âœ… API endpoints accessible"
          else
            echo "âš ï¸ API endpoints may not be ready (acceptable for new deployments)"
          fi

  # ============================================================================
  # DEPLOYMENT NOTIFICATIONS
  # ============================================================================

  notifications:
    name: ğŸ“¢ Deployment Notifications
    needs: [validate-release, ci, security-scan, deploy-dev, deploy-prod, health-check]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Send Deployment Notifications
        uses: ./.github/actions/notify
        with:
          component-name: 'WebAPI'
          node-version: '22'
          status: ${{ needs.health-check.result == 'success' && 'success' || 'failure' }}
          ci-results: |
            **ğŸ·ï¸ Release:** ${{ needs.validate-release.outputs.release-tag }}
            **ğŸ¯ Environment:** ${{ needs.validate-release.outputs.target-env }}
            **ğŸ“Š Code Quality:** ${{ needs.ci.outputs.quality-passed == 'true' && 'âœ… Passed' || (github.event.inputs.skip_tests == 'true' && 'â­ï¸ Skipped' || 'âŒ Failed') }}
            **ğŸ§ª Tests:** ${{ needs.ci.outputs.test-results || 'Skipped' }}
            **ğŸ“ˆ Coverage:** ${{ needs.ci.outputs.coverage-percentage || 'N/A' }}%
            **ğŸ›¡ï¸ Security:** ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || (github.event.inputs.skip_tests == 'true' && 'â­ï¸ Skipped' || 'âŒ Failed') }}
            **ğŸš€ Deployment:** ${{ (needs.deploy-dev.result == 'success' || needs.deploy-prod.result == 'success') && 'âœ… Success' || 'âŒ Failed' }}
            **ğŸ¥ Health Check:** ${{ needs.health-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}
          coverage-percentage: ${{ needs.ci.outputs.coverage-percentage }}
          deployment-url: ${{ needs.deploy-dev.outputs.deployment-url || needs.deploy-prod.outputs.deployment-url }}
