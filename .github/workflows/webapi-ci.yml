name: WebAPI CI Pipeline

on:
  push:
    paths:
      - 'src/webapi/**'
      - '.github/workflows/webapi-ci.yml'
      - '.github/workflows/template-node-ci.yml'
    branches:
      - develop
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'
  pull_request:
    paths:
      - 'src/webapi/**'
      - '.github/workflows/webapi-ci.yml'
      - '.github/workflows/template-node-ci.yml'
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (for debugging)'
        required: false
        default: false
        type: boolean
      cache_strategy:
        description: 'npm cache strategy'
        required: false
        default: 'use-cache'
        type: choice
        options:
          - 'use-cache'
          - 'refresh-cache'
          - 'no-cache'

env:
  NODE_VERSION: '22'

permissions:
  actions: read
  contents: read
  security-events: write
  pull-requests: write # For PR comments
  checks: write # For check runs

jobs:
  # ============================================================================
  # CONTINUOUS INTEGRATION PIPELINE
  # ============================================================================

  ci:
    name: üîç Continuous Integration
    uses: ./.github/workflows/template-node-ci.yml
    with:
      node-version: '22'
      working-directory: 'src/webapi'
      skip-tests: ${{ github.event.inputs.skip_tests == 'true' }}
      package-manager: 'npm'
    secrets: inherit

  # ============================================================================
  # CI STATUS & NOTIFICATIONS (REUSABLE)
  # ============================================================================

  ci-status-notifications:
    name: üìä CI Status & Notifications
    needs: ci
    if: always()
    uses: ./.github/workflows/template-ci-status-notifications.yml
    with:
      ci-result: ${{ needs.ci.outputs.quality-passed }}
      test-results: ${{ needs.ci.outputs.test-results }}
      build-artifact: ${{ needs.ci.outputs.build-artifact-name }}
      component-name: 'WebAPI'
      node-version: '22'
      event-type: ${{ github.event_name }}
      enable-security-report: true
      critical-branch: 'develop'

  # ============================================================================
  # PULL REQUEST INTEGRATION (REUSABLE)
  # ============================================================================

  pr-integration:
    name: üí¨ PR Integration
    needs: ci
    if: github.event_name == 'pull_request' && always()
    uses: ./.github/workflows/template-pr-integration.yml
    with:
      ci-result: ${{ needs.ci.outputs.quality-passed }}
      test-results: ${{ needs.ci.outputs.test-results }}
      build-artifact: ${{ needs.ci.outputs.build-artifact-name }}
      component-name: 'WebAPI'
      node-version: '22'
      health-endpoint: '/status'
      component-description: 'RESTful API service for Sportiverse e-commerce platform'
